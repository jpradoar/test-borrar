name: DBWriter-CI
on:
  push:
    branches:
      - main
    paths:
      - '05-dbwriter/**' # Any change in this path, make trigger build action.
      - '.github/workflows/dbwriter-ci.yaml'

env:
  REPO_APP: 'mqtt-dbwriter'
  REPO_OWNER: 'jpradoar'
  SLACK_CHANNEL: 'builds-and-ci'
  SLACK_MSG_COLOR: '#0092ff'
  BUILD_CONTEXT: './05-dbwriter'
  VULN_SEVERITY: 'CRITICAL'  
 
jobs:
  DBWriter-CI_build-docker-image:
    runs-on: ubuntu-latest 
    
    steps:
     
      - name: Show last version of docker-hub image
        id: last_version_remote_file
        run: |
          LastVersion=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.REPO_OWNER }}/${{ env.REPO_APP }}/tags/?page_size=1" | jq -r '.results[].name'|sort -M|grep -v latest)
          echo "LAST_VERSION=$LastVersion " >> "$GITHUB_OUTPUT"

      - name: Generate new version with semantic version
        id: nversion
        uses: jpradoar/ga-semanticversion@v1.0.0
        with:
          COMMIT_MSG:  ${{ github.event.head_commit.message }}
          VERSION: ${{ steps.last_version_remote_file.outputs.LAST_VERSION }}

      - name: Show new version
        run: echo "New version ${{ steps.nversion.outputs.NEW_VERSION }}" 


